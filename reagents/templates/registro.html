{% extends 'base.html' %}
{% block page_title %}Registro de Entrada{% endblock %}

{% block extra_css %}
<style>
    .main-content {
        overflow: hidden !important;
    }

    .screen.form-page-scroll {
        flex: 1 1 auto;
        min-height: 0;
        height: auto;
        overflow-y: auto !important;
        padding-right: 6px;
        padding-bottom: 24px;
    }

    .form-shell {
        max-width: 860px;
        width: 100%;
        margin: 20px auto 32px;
    }

    .form-shell h2 {
        text-align: center;
        margin-bottom: 24px;
    }

    .entry-form {
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .entry-form fieldset {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 16px;
        background: #fff;
    }

    .entry-form legend {
        padding: 0 8px;
        font-weight: 700;
    }

    .entry-form p {
        margin-bottom: 12px;
    }

    .entry-form label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
    }

    .entry-form input,
    .entry-form select,
    .entry-form textarea {
        width: 100%;
        min-height: 42px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 0 12px;
        background: #fff;
    }

    .entry-form textarea {
        min-height: 90px;
        padding-top: 10px;
    }

    .coord-row {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }

    .remove-form {
        min-height: 42px;
        min-width: 42px;
        border: none;
        border-radius: 10px;
        background: #b34233;
        color: #fff;
        cursor: pointer;
        font-size: 16px;
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        gap: 12px;
    }

    .form-actions .btn {
        min-width: 170px;
    }

    @media (max-width: 760px) {
        .coord-row {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="screen active form-page-scroll">
    <div class="form-container form-shell">
        <h2>Registro de Entrada</h2>

        <form method="post" enctype="multipart/form-data" class="entry-form">
            {% csrf_token %}

            <fieldset>
                <legend>Dados do Reagente</legend>
                {{ form.as_p }}
            </fieldset>

            <fieldset>
                <legend>Quantidades por Coordenacao</legend>
                {{ formset.management_form }}

                <div id="formset-area">
                    {% for f in formset %}
                        <div class="coord-row">
                            {{ f.coordenacao }}
                            {{ f.quantidade }}
                            <button type="button" class="remove-form" title="Remover linha">X</button>
                        </div>
                    {% endfor %}
                </div>

                <button type="button" id="add-form" class="btn btn-upload">+ Adicionar coordenacao</button>
            </fieldset>

            <div class="form-actions">
                <button type="reset" class="btn btn-clear">Limpar</button>
                <button type="submit" class="btn btn-add">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script>
const formsetArea = document.getElementById("formset-area");
const totalForms = document.getElementById("id_reagentecoordenacao_set-TOTAL_FORMS");
const addButton = document.getElementById("add-form");

addButton.addEventListener("click", function() {
    const currentFormCount = parseInt(totalForms.value);
    const firstForm = formsetArea.children[0];
    const newForm = firstForm.cloneNode(true);

    newForm.querySelectorAll("input, select").forEach((input) => {
        input.value = "";
    });

    updateElementIndex(newForm, currentFormCount);
    formsetArea.appendChild(newForm);
    totalForms.value = currentFormCount + 1;
});

formsetArea.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-form")) {
        const row = e.target.closest(".coord-row");

        if (formsetArea.children.length > 1) {
            row.remove();
            updateAllIndexes();
        } else {
            alert("E necessario pelo menos uma coordenacao.");
        }
    }
});

function updateElementIndex(element, index) {
    element.querySelectorAll("input, select, label").forEach((el) => {
        if (el.name) {
            el.name = el.name.replace(/-\d+-/, `-${index}-`);
        }
        if (el.id) {
            el.id = el.id.replace(/-\d+-/, `-${index}-`);
        }
        if (el.htmlFor) {
            el.htmlFor = el.htmlFor.replace(/-\d+-/, `-${index}-`);
        }
    });
}

function updateAllIndexes() {
    const rows = document.querySelectorAll(".coord-row");
    rows.forEach((row, index) => {
        updateElementIndex(row, index);
    });
    totalForms.value = rows.length;
}

function getAllSelects() {
    return document.querySelectorAll(".coord-row select");
}

function updateCoordOptions() {
    const selects = getAllSelects();
    const selectedValues = Array.from(selects)
        .map((s) => s.value)
        .filter((v) => v !== "");

    selects.forEach((select) => {
        Array.from(select.options).forEach((option) => {
            if (option.value === "") return;
            option.disabled = selectedValues.includes(option.value) && option.value !== select.value;
        });
    });
}

formsetArea.addEventListener("change", function(e) {
    if (e.target.tagName === "SELECT") {
        updateCoordOptions();
    }
});

addButton.addEventListener("click", function() {
    setTimeout(updateCoordOptions, 0);
});

formsetArea.addEventListener("click", function(e) {
    if (e.target.classList.contains("remove-form")) {
        setTimeout(updateCoordOptions, 0);
    }
});

updateCoordOptions();
</script>
{% endblock %}
